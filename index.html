<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سورة الزلزلة - استماع وتحفيظ</title>
    <style>
        @font-face {
            font-family: 'HafsFont';
            src: url('conv_original-hafs.otf') format('opentype'); /* Ensure this font file is accessible */
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'HafsFont', Arial, sans-serif;
            text-align: center;
            padding: 20px;
            direction: rtl;
            background-color: #f4f4f4;
            margin: 0;
            -webkit-tap-highlight-color: transparent; /* Prevent tap highlight on mobile */
        }

        h1 {
            font-size: 2em; 
            color: #333;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        /* Mode Selector Buttons */
        #modeSelector {
            margin-bottom: 20px;
        }
        .mode-select-button {
            padding: 12px 25px;
            font-size: 20px; 
            font-family: Arial, sans-serif; 
            cursor: pointer;
            border: none;
            background: #007BFF; 
            color: white;
            border-radius: 10px;
            margin: 10px 5px;
            min-width: 130px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .mode-select-button:hover, .mode-select-button:focus {
            background: #0056b3;
            outline: none;
        }
        .mode-select-button.active {
            background: #004085; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }


        /* Shared Sentence Display */
        #sentence {
            font-size: 28px; 
            line-height: 2.4;
            max-width: 90%; 
            margin: 15px auto;
            text-align: right;
            padding: 12px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Default state for words in #sentence */
        #sentence > span:not(.ayah-number),
        .bismillah-container > span {
            display: inline-block;
            padding: 1px 3px;
            margin: 0 1px;
            border-radius: 3px;
            vertical-align: baseline;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            cursor: default; 
            visibility: hidden; /* CRITICAL: Words start hidden by default CSS */
        }

        .bismillah-container {
            text-align: center;
            margin-bottom: 0.5em;
        }
        .ayah-number {
            color: #007BFF;
            font-size: 0.75em;
            margin: 0 3px;
            display: inline;
            visibility: visible !important; /* Ayah numbers always visible */
        }

        /* Word Styling Classes (shared by both modes) */
        .highlight-active-word { /* Current word being focused on or spoken */
            background-color: #00ff84 !important;
            color: #000 !important;
            visibility: visible !important; /* CRITICAL: Makes the word visible */
        }
        .processed-word { /* Word that has been successfully processed (spoken or played) */
            background-color: #c8f7dc !important;
            color: #333 !important;
            visibility: visible !important; /* CRITICAL: Makes the word visible */
        }

        /* Controls for individual modes */
        .controls {
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .controls button {
            padding: 12px 20px;
            font-size: 20px; 
            font-family: Arial, sans-serif;
            cursor: pointer;
            border: none;
            background: #007BFF;
            color: white;
            border-radius: 10px;
            margin: 10px 5px;
            min-width: 140px; 
            line-height: 1.2;
            transition: background-color 0.3s ease;
        }
        .controls button:hover, .controls button:focus {
            background: #0056b3;
            outline: none;
        }
        .controls button:active {
            background: #004085;
        }
        
        #memorizeControls #resetButtonMemorize { background-color: #6c757d; }
        #memorizeControls #resetButtonMemorize:hover, 
        #memorizeControls #resetButtonMemorize:focus { background-color: #5a6268; }
        #memorizeControls #resetButtonMemorize:active { background-color: #495057; }
        #memorizeControls #speechButtonMemorize.listening { background-color: #dc3545; }
        #listenControls #playPauseButtonListen { min-width: 70px; font-size: 24px; }

        #speechStatusMemorize {
            font-size: 0.9em; color: #555; min-height: 2.5em; 
            margin-bottom: 10px; padding: 5px; line-height: 1.4;
        }
        #audioPlayerListen { display: none; }

        @media (max-width: 600px) { /* ... (responsive styles remain the same) ... */ }
        @media (max-width: 400px) { /* ... (responsive styles remain the same) ... */ }
    </style>
</head>
<body>
    <h1>سورة الزلزلة</h1>
    <div id="modeSelector">
        <button id="btnSelectListen" class="mode-select-button">اسمع</button>
        <button id="btnSelectMemorize" class="mode-select-button">احفظ</button>
    </div>
    <div id="listenModeUI" style="display: none;"> /* ... (UI remains the same) ... */ </div>
    <div id="memorizeModeUI" style="display: none;"> /* ... (UI remains the same) ... */ </div>
    <div id="sentence" style="display: none;"> /* ... (Sentence HTML remains the same) ... */ </div>

<script>
    // --- Common DOM Elements ---
    const btnSelectListen = document.getElementById('btnSelectListen');
    const btnSelectMemorize = document.getElementById('btnSelectMemorize');
    const listenModeUI = document.getElementById('listenModeUI');
    const memorizeModeUI = document.getElementById('memorizeModeUI');
    const sentenceContainerShared = document.getElementById('sentence');
    const allWordSpansShared = Array.from(
        sentenceContainerShared.querySelectorAll('#sentence > span:not(.ayah-number), .bismillah-container > span')
    );
    let currentActiveMode = null;

    // --- Global Helper ---
    function resetAllWordStylingAndHide() {
        console.log("[GLOBAL] resetAllWordStylingAndHide called.");
        allWordSpansShared.forEach(span => {
            span.classList.remove('highlight-active-word', 'processed-word');
            // Explicitly hide. This is crucial for ensuring Memorize mode starts clean.
            span.style.visibility = 'hidden'; 
            span.style.cursor = 'default';
        });
    }

    // --- Listen Mode (اسمع) ---
    const listen_audioPlayer = document.getElementById("audioPlayerListen");
    const listen_playPauseButton = document.getElementById("playPauseButtonListen");
    const listen_words = Array.from(sentenceContainerShared.querySelectorAll("span[data-time]"));
    let listen_isPaused = false; let listen_audioWasEnded = false;

    function listen_resetHighlights() { /* ... (same) ... */ }
    function listen_toggleAudio() { /* ... (same) ... */ }
    function listen_highlightWords() { /* ... (same) ... */ }
    
    function initListenMode() {
        console.log("[LISTEN] Initializing Listen Mode.");
        listenModeUI.style.display = 'block';
        sentenceContainerShared.style.display = 'block'; // Show the sentence container
        
        resetAllWordStylingAndHide(); // Start with all words hidden

        // For Listen mode, make all words visible and clickable.
        allWordSpansShared.forEach(span => {
            span.style.visibility = 'visible'; 
            span.style.cursor = 'pointer'; 
        });
        
        listen_playPauseButton.textContent = "▶️";
        listen_audioPlayer.currentTime = 0;
        listen_isPaused = true; listen_audioWasEnded = false;
        // Attach event listeners for listen mode... (same as before)
        listen_playPauseButton.onclick = listen_toggleAudio;
        listen_audioPlayer.ontimeupdate = listen_highlightWords;
        listen_audioPlayer.onended = () => { /* ... */ };
        listen_audioPlayer.onplay = () => { /* ... */ };
        listen_audioPlayer.onseeked = () => { /* ... */ };
        listen_words.forEach(word => { word.onclick = function() { /* ... */ }; });
        console.log("[LISTEN] Listen mode initialized and words made visible.");
    }

    function deactivateListenMode() { /* ... (same as before) ... */ }

    // --- Memorize Mode (احفظ) ---
    const memorize_speechButton = document.getElementById("speechButtonMemorize");
    const memorize_speechStatus = document.getElementById("speechStatusMemorize");
    const memorize_resetButton = document.getElementById("resetButtonMemorize");
    const memorize_wordSpans = allWordSpansShared; 

    let memorize_currentWordIndex = 0;
    let memorize_isRecognizing = false;
    let memorize_accumulatedFinalTranscript = "";
    let memorize_shouldRestart = false;
    let memorize_restartTimeout; let memorize_silenceTimeout;
    let memorize_recognition;

    function memorize_normalizeArabic(text) { /* ... (same) ... */ }
    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognitionAPI) {
        memorize_recognition = new SpeechRecognitionAPI();
        memorize_recognition.continuous = true; memorize_recognition.interimResults = true;
        memorize_recognition.lang = 'ar-SA';
        memorize_recognition.onstart = () => { /* ... (same) ... */ };
        memorize_recognition.onend = () => { /* ... (same) ... */ };
        function memorize_updateUIForStopped() { /* ... (same) ... */ }
        memorize_recognition.onerror = (event) => { /* ... (same) ... */ };

        memorize_recognition.onresult = (event) => {
            // console.log("[MEMORIZE] SpeechRecognition.onresult");
            if (memorize_silenceTimeout) clearTimeout(memorize_silenceTimeout); memorize_silenceTimeout = null;
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcriptPart = event.results[i][0].transcript;
                if (event.results[i].isFinal) memorize_accumulatedFinalTranscript += transcriptPart + " ";
                else interimTranscript += transcriptPart;
            }
            if (interimTranscript && memorize_isRecognizing) { /* ... (status update same) ... */ }
            if (memorize_accumulatedFinalTranscript && memorize_currentWordIndex < memorize_wordSpans.length && memorize_isRecognizing) {
                const wordsToProcess = memorize_accumulatedFinalTranscript.trim().split(" ");
                memorize_accumulatedFinalTranscript = ""; 
                for (let spokenWord of wordsToProcess) {
                    if (!memorize_isRecognizing || memorize_currentWordIndex >= memorize_wordSpans.length) break;
                    const normalizedSpokenWord = memorize_normalizeArabic(spokenWord);
                    if (!normalizedSpokenWord) continue;
                    const targetWordSpan = memorize_wordSpans[memorize_currentWordIndex];
                    const targetWordText = targetWordSpan.dataset.word; 
                    
                    // console.log(`[MEMORIZE] Comparing (idx ${memorize_currentWordIndex}): Spoken='${normalizedSpokenWord}', Target='${targetWordText}'`);

                    if (targetWordText && normalizedSpokenWord === targetWordText) {
                        // console.log("[MEMORIZE] MATCH FOUND!");
                        const previouslyHighlighted = sentenceContainerShared.querySelector('.highlight-active-word');
                        if (previouslyHighlighted && previouslyHighlighted !== targetWordSpan) {
                            previouslyHighlighted.classList.remove('highlight-active-word');
                            previouslyHighlighted.classList.add('processed-word'); // Stays visible
                        }
                        targetWordSpan.classList.remove('processed-word'); 
                        targetWordSpan.classList.add('highlight-active-word'); // This class makes it visible
                        
                        memorize_currentWordIndex++;
                        if (memorize_currentWordIndex < memorize_wordSpans.length && memorize_isRecognizing) { /* ... (status update same) ... */ }
                    } // else { console.log("[MEMORIZE] NO MATCH."); }
                }
                if (memorize_currentWordIndex >= memorize_wordSpans.length) { /* ... (completion same) ... */ }
            }
        };
    } 

    function memorize_toggleSpeechRecognition() { /* ... (same) ... */ }

    function memorize_resetActivity() {
        console.log("[MEMORIZE] memorize_resetActivity called.");
        memorize_currentWordIndex = 0;
        memorize_accumulatedFinalTranscript = "";
        memorize_shouldRestart = false; 
        
        if (memorize_restartTimeout) clearTimeout(memorize_restartTimeout);
        if (memorize_silenceTimeout) clearTimeout(memorize_silenceTimeout);
        memorize_restartTimeout = null; memorize_silenceTimeout = null;
        
        // For memorize mode reset, ensure all words are hidden.
        // The global helper function now handles this explicitly.
        resetAllWordStylingAndHide();

        memorize_speechStatus.textContent = "اضغط \"ابدأ\" وتحدث";
        
        if (memorize_isRecognizing) { /* ... (stop recognition same) ... */ }
        else { memorize_updateUIForStopped(); }
    }
    
    function initMemorizeMode() {
        console.log("[MEMORIZE] Initializing Memorize Mode.");
        memorizeModeUI.style.display = 'block';
        sentenceContainerShared.style.display = 'block'; // Show the sentence container
        
        // CRITICAL: Ensure all words start hidden for Memorize mode.
        resetAllWordStylingAndHide(); 
        
        allWordSpansShared.forEach(span => {
            span.style.cursor = 'default'; // Words not clickable in memorize mode
        });

        if (!SpeechRecognitionAPI) { /* ... (API not found handling same) ... */ return; }
        else { /* ... (enable buttons same) ... */ }

        memorize_wordSpans.forEach(span => {
            const originalText = span.textContent;
            const normalizedText = memorize_normalizeArabic(originalText);
            span.dataset.word = normalizedText;
        });
        
        // Call resetActivity to set initial UI state (like button text)
        // resetAllWordStylingAndHide inside resetActivity already made words hidden.
        memorize_currentWordIndex = 0; // Ensure index is reset before UI update
        memorize_accumulatedFinalTranscript = "";
        memorize_shouldRestart = false;
        memorize_updateUIForStopped(); // Update button text and status message

        // Attach event listeners for memorize mode... (same as before)
        memorize_speechButton.onclick = memorize_toggleSpeechRecognition;
        memorize_resetButton.onclick = memorize_resetActivity;
        console.log("[MEMORIZE] Memorize mode initialized and words are hidden.");
    }

    function deactivateMemorizeMode() { /* ... (same as before) ... */ }

    // --- Mode Switching Logic ---
    function switchToMode(mode) {
        console.log(`[GLOBAL] Switching mode to: ${mode}. Current: ${currentActiveMode}`);
        if (currentActiveMode === 'listen') {
            deactivateListenMode();
            btnSelectListen.classList.remove('active');
        } else if (currentActiveMode === 'memorize') {
            deactivateMemorizeMode();
            btnSelectMemorize.classList.remove('active');
        }

        // CRITICAL: Always reset and hide all words before initializing any mode.
        // This ensures Memorize mode always starts with hidden words.
        resetAllWordStylingAndHide(); 
        sentenceContainerShared.style.display = 'none'; // Hide sentence container before mode init

        if (mode === 'listen') {
            initListenMode(); // Listen mode will show sentence and make words visible.
            btnSelectListen.classList.add('active');
            currentActiveMode = 'listen';
        } else if (mode === 'memorize') {
            initMemorizeMode(); // Memorize mode will show sentence, words remain hidden until spoken.
            btnSelectMemorize.classList.add('active');
            currentActiveMode = 'memorize';
        } else { 
            // No mode selected (initial state or error)
            listenModeUI.style.display = 'none';
            memorizeModeUI.style.display = 'none';
            // sentenceContainerShared is already hidden by resetAllWordStylingAndHide + display='none'
            currentActiveMode = null;
        }
        console.log(`[GLOBAL] Mode switched. New active: ${currentActiveMode}`);
    }

    btnSelectListen.addEventListener('click', () => switchToMode('listen'));
    btnSelectMemorize.addEventListener('click', () => switchToMode('memorize'));

    switchToMode(null); 
    console.log("[GLOBAL] Page loaded. Select a mode to begin.");

    // --- Minified function stubs for brevity in explanation (full code is above) ---
    listen_resetHighlights = function(){/*...*/}; listen_toggleAudio = function(){/*...*/}; listen_highlightWords = function(){/*...*/}; 
    deactivateListenMode = function(){/*...*/}; 
    memorize_normalizeArabic = function(t){return t?(t=t.replace(/[إأآٱ]/g,"ا").replace(/ى/g,"ي").replace(/ؤ/g,"و").replace(/ئ/g,"ي").replace(/ة/g,"ه").trim()):""};
    if(SpeechRecognitionAPI){memorize_recognition.onstart=()=>{/*...*/}; memorize_recognition.onend=()=>{/*...*/}; memorize_updateUIForStopped=function(){/*...*/}; memorize_recognition.onerror=e=>{/*...*/};}
    memorize_toggleSpeechRecognition=function(){/*...*/};
    deactivateMemorizeMode=function(){/*...*/};
    // Make sure UI is correctly handled
    document.addEventListener('DOMContentLoaded', () => {
        const elementsToKeep = {
            listenModeUI, memorizeModeUI, sentenceContainerShared,
            audioPlayerListen: document.getElementById("audioPlayerListen"),
            playPauseButtonListen: document.getElementById("playPauseButtonListen"),
            speechStatusMemorize: document.getElementById("speechStatusMemorize"),
            speechButtonMemorize: document.getElementById("speechButtonMemorize"),
            resetButtonMemorize: document.getElementById("resetButtonMemorize")
        };
        // Placeholder: if you were removing/adding full function blocks before, this is where you'd re-attach them.
        // For this version, the functions are globally scoped and should remain.
    });

</script>
</body>
</html>
