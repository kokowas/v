<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆØ±Ø© Ø§Ù„Ø²Ù„Ø²Ù„Ø© - Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØªØ­ÙÙŠØ¸</title>
    <style>
        @font-face {
            font-family: 'HafsFont';
            src: url('conv_original-hafs.otf') format('opentype'); /* Ensure this font file is accessible */
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'HafsFont', Arial, sans-serif;
            text-align: center;
            padding: 20px;
            direction: rtl;
            background-color: #f4f4f4;
            margin: 0;
            -webkit-tap-highlight-color: transparent; /* Prevent tap highlight on mobile */
        }

        h1 {
            font-size: 2em; 
            color: #333;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        /* Mode Selector Buttons */
        #modeSelector {
            margin-bottom: 20px;
        }
        .mode-select-button {
            padding: 12px 25px;
            font-size: 20px; 
            font-family: Arial, sans-serif; 
            cursor: pointer;
            border: none;
            background: #007BFF; 
            color: white;
            border-radius: 10px;
            margin: 10px 5px;
            min-width: 130px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .mode-select-button:hover, .mode-select-button:focus {
            background: #0056b3;
            outline: none;
        }
        .mode-select-button.active {
            background: #004085; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }


        /* Shared Sentence Display */
        #sentence {
            font-size: 28px; 
            line-height: 2.4;
            max-width: 90%; 
            margin: 15px auto;
            text-align: right;
            padding: 12px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Default state for words in #sentence */
        #sentence > span:not(.ayah-number),
        .bismillah-container > span {
            display: inline-block;
            padding: 1px 3px;
            margin: 0 1px;
            border-radius: 3px;
            vertical-align: baseline;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
            cursor: default; 
            visibility: hidden; /* THIS IS KEY: Words start hidden by default */
        }

        .bismillah-container {
            text-align: center;
            margin-bottom: 0.5em;
        }
        .ayah-number {
            color: #007BFF;
            font-size: 0.75em;
            margin: 0 3px;
            display: inline;
            visibility: visible !important; /* Ayah numbers always visible */
        }

        /* Word Styling Classes (shared by both modes) */
        .highlight-active-word { /* Current word being focused on or spoken */
            background-color: #00ff84 !important;
            color: #000 !important;
            visibility: visible !important; /* Makes the word visible */
        }
        .processed-word { /* Word that has been successfully processed (spoken or played) */
            background-color: #c8f7dc !important;
            color: #333 !important;
            visibility: visible !important; /* Makes the word visible */
        }

        /* Controls for individual modes */
        .controls {
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .controls button {
            padding: 12px 20px;
            font-size: 20px; 
            font-family: Arial, sans-serif;
            cursor: pointer;
            border: none;
            background: #007BFF;
            color: white;
            border-radius: 10px;
            margin: 10px 5px;
            min-width: 140px; 
            line-height: 1.2;
            transition: background-color 0.3s ease;
        }
        .controls button:hover, .controls button:focus {
            background: #0056b3;
            outline: none;
        }
        .controls button:active {
            background: #004085;
        }
        
        /* Memorize Mode Specific Button Styling */
        #memorizeControls #resetButtonMemorize {
            background-color: #6c757d;
        }
        #memorizeControls #resetButtonMemorize:hover, 
        #memorizeControls #resetButtonMemorize:focus {
            background-color: #5a6268;
        }
        #memorizeControls #resetButtonMemorize:active {
            background-color: #495057;
        }
        #memorizeControls #speechButtonMemorize.listening {
            background-color: #dc3545; /* Red when listening */
        }
        
        /* Listen Mode Specific Button Styling */
        #listenControls #playPauseButtonListen {
             min-width: 70px; 
             font-size: 24px; 
        }


        /* Memorize Mode Status */
        #speechStatusMemorize {
            font-size: 0.9em;
            color: #555;
            min-height: 2.5em; 
            margin-bottom: 10px;
            padding: 5px;
            line-height: 1.4;
        }
        
        #audioPlayerListen {
            display: none;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.8em; }
            #sentence { font-size: 24px; line-height: 2.3; }
            .mode-select-button, .controls button { font-size: 18px; padding: 10px 15px; min-width: 120px; }
            #listenControls #playPauseButtonListen { font-size: 22px; }
            .ayah-number { font-size: 0.7em; }
        }
        @media (max-width: 400px) {
            body { padding: 10px; }
            h1 { font-size: 1.6em; }
            #sentence { font-size: 20px; line-height: 2.2; }
            .mode-select-button, .controls button { font-size: 16px; padding: 8px 12px; min-width: 100px; }
            #listenControls #playPauseButtonListen { font-size: 20px; }
            .ayah-number { font-size: 0.65em; }
        }
    </style>
</head>
<body>

    <h1>Ø³ÙˆØ±Ø© Ø§Ù„Ø²Ù„Ø²Ù„Ø©</h1>

    <div id="modeSelector">
        <button id="btnSelectListen" class="mode-select-button">Ø§Ø³Ù…Ø¹</button>
        <button id="btnSelectMemorize" class="mode-select-button">Ø§Ø­ÙØ¸</button>
    </div>

    <div id="listenModeUI" style="display: none;">
        <audio id="audioPlayerListen" src="099.mp3"></audio>
        <div class="controls" id="listenControls">
            <button id="playPauseButtonListen">â–¶ï¸</button>
        </div>
    </div>

    <div id="memorizeModeUI" style="display: none;">
        <div id="speechStatusMemorize">Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" ÙˆØªØ­Ø¯Ø«</div>
        <div class="controls" id="memorizeControls">
            <button id="speechButtonMemorize">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯Ø«</button>
            <button id="resetButtonMemorize">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>
    </div>

    <div id="sentence" style="display: none;">
        <div class="bismillah-container">
            <span data-time="0.79">Ø¨ÙØ³Ù’Ù…Ù</span>
            <span data-time="1.17">Ø§Ù„Ù„Ù‘ÙÙ‡Ù</span>
            <span data-time="1.87">Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù</span>
            <span data-time="2.93">Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù</span>
        </div>
        <span data-time="6.59">Ø¥ÙØ°ÙØ§</span>
        <span data-time="7.22">Ø²ÙÙ„Ù’Ø²ÙÙ„ÙØªÙ</span>
        <span data-time="7.99">Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù</span>
        <span data-time="8.79">Ø²ÙÙ„Ù’Ø²ÙØ§Ù„ÙÙ‡ÙØ§</span><span class="ayah-number">ÛÙ¡</span>
        <span data-time="11.72">ÙˆÙØ£ÙØ®Ù’Ø±ÙØ¬ÙØªÙ</span>
        <span data-time="12.71">Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù</span>
        <span data-time="13.62">Ø£ÙØ«Ù’Ù‚ÙØ§Ù„ÙÙ‡ÙØ§</span><span class="ayah-number">ÛÙ¢</span>
        <span data-time="16.28">ÙˆÙÙ‚ÙØ§Ù„Ù</span>
        <span data-time="17.23">Ø§Ù„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ù</span>
        <span data-time="19.71">Ù…ÙØ§</span>
        <span data-time="20.18">Ù„ÙÙ‡ÙØ§</span><span class="ayah-number">ÛÙ£</span>
        <span data-time="21.89">ÙŠÙÙˆÙ’Ù…ÙØ¦ÙØ°Ù</span>
        <span data-time="23.62">ØªÙØ­ÙØ¯Ù‘ÙØ«Ù</span>
        <span data-time="24.89">Ø£ÙØ®Ù’Ø¨ÙØ§Ø±ÙÙ‡ÙØ§</span><span class="ayah-number">ÛÙ¤</span>
        <span data-time="27.69">Ø¨ÙØ£ÙÙ†Ù‘Ù</span>
        <span data-time="28.88">Ø±ÙØ¨Ù‘ÙÙƒÙ</span>
        <span data-time="30.21">Ø£ÙÙˆÙ’Ø­ÙÙ‰Ù°</span>
        <span data-time="31.18">Ù„ÙÙ‡ÙØ§</span><span class="ayah-number">ÛÙ¥</span>
        <span data-time="32.66">ÙŠÙÙˆÙ’Ù…ÙØ¦ÙØ°Ù</span>
        <span data-time="34.35">ÙŠÙØµÙ’Ø¯ÙØ±Ù</span>
        <span data-time="35.54">Ø§Ù„Ù†Ù‘ÙØ§Ø³Ù</span>
        <span data-time="36.99">Ø£ÙØ´Ù’ØªÙØ§ØªÙ‹Ø§</span>
        <span data-time="38.39">Ù„ÙÙŠÙØ±ÙÙˆÙ’Ø§</span>
        <span data-time="39.50">Ø£ÙØ¹Ù’Ù…ÙØ§Ù„ÙÙ‡ÙÙ…Ù’</span><span class="ayah-number">ÛÙ¦</span>
        <span data-time="41.76">ÙÙÙ…ÙÙ†</span>
        <span data-time="42.48">ÙŠÙØ¹Ù’Ù…ÙÙ„Ù’</span>
        <span data-time="43.48">Ù…ÙØ«Ù’Ù‚ÙØ§Ù„Ù</span>
        <span data-time="44.49">Ø°ÙØ±Ù‘ÙØ©Ù</span>
        <span data-time="45.69">Ø®ÙÙŠÙ’Ø±Ù‹Ø§</span>
        <span data-time="47.04">ÙŠÙØ±ÙÙ‡Ù</span><span class="ayah-number">ÛÙ§</span>
        <span data-time="49.31">ÙˆÙÙ…ÙÙ†</span>
        <span data-time="50.08">ÙŠÙØ¹Ù’Ù…ÙÙ„Ù’</span>
        <span data-time="51.26">Ù…ÙØ«Ù’Ù‚ÙØ§Ù„Ù</span>
        <span data-time="52.39">Ø°ÙØ±Ù‘ÙØ©Ù</span>
        <span data-time="54.02">Ø´ÙØ±Ù‘Ù‹Ø§</span>
        <span data-time="56.18">ÙŠÙØ±ÙÙ‡Ù</span><span class="ayah-number">ÛÙ¨</span>
    </div>

<script>
    // --- Common DOM Elements ---
    const btnSelectListen = document.getElementById('btnSelectListen');
    const btnSelectMemorize = document.getElementById('btnSelectMemorize');
    const listenModeUI = document.getElementById('listenModeUI');
    const memorizeModeUI = document.getElementById('memorizeModeUI');
    const sentenceContainerShared = document.getElementById('sentence');
    const allWordSpansShared = Array.from(
        sentenceContainerShared.querySelectorAll('#sentence > span:not(.ayah-number), .bismillah-container > span')
    );

    let currentActiveMode = null; 

    // --- Global Helper ---
    function resetAllWordStylesAndEnsureHidden() {
        console.log("[GLOBAL] resetAllWordStylesAndEnsureHidden called.");
        allWordSpansShared.forEach(span => {
            span.classList.remove('highlight-active-word', 'processed-word');
            // The CSS default is visibility: hidden. This function ensures classes are removed.
            // No need to set span.style.visibility = 'hidden' here if CSS is doing its job.
            span.style.cursor = 'default';
        });
    }

    // --- Listen Mode (Ø§Ø³Ù…Ø¹) ---
    const listen_audioPlayer = document.getElementById("audioPlayerListen");
    const listen_playPauseButton = document.getElementById("playPauseButtonListen");
    const listen_words = Array.from(sentenceContainerShared.querySelectorAll("span[data-time]"));
    let listen_isPaused = false;
    let listen_audioWasEnded = false;

    function listen_resetHighlights() { /* ... (same as before) ... */ }
    function listen_toggleAudio() { /* ... (same as before) ... */ }
    function listen_highlightWords() { /* ... (same as before) ... */ }
    
    function initListenMode() {
        console.log("[LISTEN] Initializing Listen Mode.");
        listenModeUI.style.display = 'block';
        sentenceContainerShared.style.display = 'block';
        
        // For Listen mode, all words become visible.
        allWordSpansShared.forEach(span => {
            span.classList.remove('highlight-active-word', 'processed-word'); // Clear any previous state
            span.style.visibility = 'visible'; 
            span.style.cursor = 'pointer'; 
        });
        
        listen_playPauseButton.textContent = "â–¶ï¸";
        listen_audioPlayer.currentTime = 0;
        listen_isPaused = true; 
        listen_audioWasEnded = false;
        listen_playPauseButton.onclick = listen_toggleAudio;
        listen_audioPlayer.ontimeupdate = listen_highlightWords;
        listen_audioPlayer.onended = () => {
            listen_playPauseButton.textContent = "ğŸ”„";
            listen_isPaused = true;
            listen_audioWasEnded = true;
            listen_words.forEach(w => {
                 if (w.classList.contains('highlight-active-word')) { w.classList.remove('highlight-active-word'); w.classList.add('processed-word'); }
                 else if (w.hasAttribute('data-time') && parseFloat(w.dataset.time) <= listen_audioPlayer.currentTime) { w.classList.add('processed-word'); }
            });
        };
        listen_audioPlayer.onplay = () => { listen_isPaused = false; listen_highlightWords(); };
        listen_audioPlayer.onseeked = listen_highlightWords;
        listen_words.forEach(word => {
            word.onclick = function() {
                if (listen_audioWasEnded) { listen_resetHighlights(); listen_audioWasEnded = false; }
                let startTime = parseFloat(this.dataset.time);
                listen_audioPlayer.currentTime = startTime;
                listen_highlightWords(); 
                if (listen_audioPlayer.paused || listen_audioPlayer.ended) { listen_audioPlayer.play(); listen_isPaused = false; listen_playPauseButton.textContent = "â¸ï¸"; }
            };
        });
        console.log("[LISTEN] Listen mode initialized.");
    }

    function deactivateListenMode() { /* ... (same as before) ... */ }

    // --- Memorize Mode (Ø§Ø­ÙØ¸) ---
    const memorize_speechButton = document.getElementById("speechButtonMemorize");
    const memorize_speechStatus = document.getElementById("speechStatusMemorize");
    const memorize_resetButton = document.getElementById("resetButtonMemorize");
    const memorize_wordSpans = allWordSpansShared; 

    let memorize_currentWordIndex = 0;
    let memorize_isRecognizing = false;
    let memorize_accumulatedFinalTranscript = "";
    let memorize_shouldRestart = false;
    let memorize_restartTimeout;
    let memorize_silenceTimeout;
    let memorize_recognition;

    function memorize_normalizeArabic(text) { /* ... (same as before) ... */ }
    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognitionAPI) {
        memorize_recognition = new SpeechRecognitionAPI();
        memorize_recognition.continuous = true;
        memorize_recognition.interimResults = true;
        memorize_recognition.lang = 'ar-SA';
        memorize_recognition.onstart = () => { /* ... (same as before) ... */ };
        memorize_recognition.onend = () => { /* ... (same as before) ... */ };
        function memorize_updateUIForStopped() { /* ... (same as before) ... */ }
        memorize_recognition.onerror = (event) => { /* ... (same as before) ... */ };

        memorize_recognition.onresult = (event) => {
            // console.log("[MEMORIZE] SpeechRecognition.onresult"); // Keep for debugging if needed
            if (memorize_silenceTimeout) clearTimeout(memorize_silenceTimeout); memorize_silenceTimeout = null;
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcriptPart = event.results[i][0].transcript;
                if (event.results[i].isFinal) memorize_accumulatedFinalTranscript += transcriptPart + " ";
                else interimTranscript += transcriptPart;
            }
            if (interimTranscript && memorize_isRecognizing) {
                memorize_speechStatus.textContent = "Ù„Ø­Ø¸Ø©... " + interimTranscript;
                memorize_silenceTimeout = setTimeout(() => {
                    if (memorize_isRecognizing && memorize_shouldRestart && memorize_currentWordIndex < memorize_wordSpans.length) memorize_speechStatus.textContent = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©...";
                }, 3000);
            }
            if (memorize_accumulatedFinalTranscript && memorize_currentWordIndex < memorize_wordSpans.length && memorize_isRecognizing) {
                const wordsToProcess = memorize_accumulatedFinalTranscript.trim().split(" ");
                memorize_accumulatedFinalTranscript = ""; 
                for (let spokenWord of wordsToProcess) {
                    if (!memorize_isRecognizing || memorize_currentWordIndex >= memorize_wordSpans.length) break;
                    const normalizedSpokenWord = memorize_normalizeArabic(spokenWord);
                    if (!normalizedSpokenWord) continue;
                    const targetWordSpan = memorize_wordSpans[memorize_currentWordIndex];
                    const targetWordText = targetWordSpan.dataset.word; 
                    if (targetWordText && normalizedSpokenWord === targetWordText) {
                        const previouslyHighlighted = sentenceContainerShared.querySelector('.highlight-active-word');
                        if (previouslyHighlighted && previouslyHighlighted !== targetWordSpan) {
                            previouslyHighlighted.classList.remove('highlight-active-word');
                            previouslyHighlighted.classList.add('processed-word');
                        }
                        targetWordSpan.classList.remove('processed-word'); 
                        targetWordSpan.classList.add('highlight-active-word'); // This class makes it visible
                        memorize_currentWordIndex++;
                        if (memorize_currentWordIndex < memorize_wordSpans.length && memorize_isRecognizing) memorize_speechStatus.textContent = "Ù…Ù…ØªØ§Ø²! Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©...";
                    }
                }
                if (memorize_currentWordIndex >= memorize_wordSpans.length) {
                    memorize_speechStatus.textContent = "Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø³ÙˆØ±Ø©.";
                    memorize_shouldRestart = false;
                    if (memorize_isRecognizing) memorize_recognition.stop(); 
                    else memorize_updateUIForStopped(); 
                }
            }
        };
    } 

    function memorize_toggleSpeechRecognition() { /* ... (same as before) ... */ }

    function memorize_resetActivity() {
        console.log("[MEMORIZE] memorize_resetActivity called.");
        memorize_currentWordIndex = 0;
        memorize_accumulatedFinalTranscript = "";
        memorize_shouldRestart = false; 
        
        if (memorize_restartTimeout) clearTimeout(memorize_restartTimeout);
        if (memorize_silenceTimeout) clearTimeout(memorize_silenceTimeout);
        memorize_restartTimeout = null; memorize_silenceTimeout = null;
        
        // For memorize mode reset, ensure all words are hidden by removing highlight/processed classes.
        // The CSS default `visibility: hidden` will take effect.
        allWordSpansShared.forEach(span => {
            span.classList.remove('highlight-active-word', 'processed-word');
            // No need to set span.style.visibility = 'hidden' if CSS default is active
        });

        memorize_speechStatus.textContent = "Ø§Ø¶ØºØ· \"Ø§Ø¨Ø¯Ø£\" ÙˆØªØ­Ø¯Ø«";
        
        if (memorize_isRecognizing) {
            console.log("[MEMORIZE] resetActivity: Recognition active, stopping.");
            memorize_recognition.stop(); 
        } else {
            memorize_updateUIForStopped();
        }
    }
    
    function initMemorizeMode() {
        console.log("[MEMORIZE] Initializing Memorize Mode.");
        memorizeModeUI.style.display = 'block';
        sentenceContainerShared.style.display = 'block';
        
        // Ensure all words start hidden for Memorize mode by removing any classes that make them visible.
        // The CSS default `visibility: hidden` for these spans will apply.
        allWordSpansShared.forEach(span => {
            span.classList.remove('highlight-active-word', 'processed-word');
            span.style.cursor = 'default'; 
        });

        if (!SpeechRecognitionAPI) {
            memorize_speechButton.disabled = true; memorize_speechButton.textContent = "ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…";
            memorize_resetButton.disabled = true;
            memorize_speechStatus.textContent = "Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.";
            console.error("[MEMORIZE] SpeechRecognition API not found."); return;
        } else {
             memorize_speechButton.disabled = false; memorize_resetButton.disabled = false;
        }

        memorize_wordSpans.forEach(span => {
            const originalText = span.textContent;
            const normalizedText = memorize_normalizeArabic(originalText);
            span.dataset.word = normalizedText;
        });
        
        memorize_resetActivity(); // Sets up UI, currentWordIndex, and ensures words are hidden.

        memorize_speechButton.onclick = memorize_toggleSpeechRecognition;
        memorize_resetButton.onclick = memorize_resetActivity;
        console.log("[MEMORIZE] Memorize mode initialized.");
    }

    function deactivateMemorizeMode() { /* ... (same as before) ... */ }

    // --- Mode Switching Logic ---
    function switchToMode(mode) {
        console.log(`[GLOBAL] Switching mode to: ${mode}. Current: ${currentActiveMode}`);
        if (currentActiveMode === 'listen') {
            deactivateListenMode();
            btnSelectListen.classList.remove('active');
        } else if (currentActiveMode === 'memorize') {
            deactivateMemorizeMode();
            btnSelectMemorize.classList.remove('active');
        }

        // Global reset ensures words are hidden before a new mode sets its specific visibility.
        resetAllWordStylesAndEnsureHidden();

        if (mode === 'listen') {
            initListenMode(); // Listen mode will make words visible.
            btnSelectListen.classList.add('active');
            currentActiveMode = 'listen';
        } else if (mode === 'memorize') {
            initMemorizeMode(); // Memorize mode will keep words hidden until spoken.
            btnSelectMemorize.classList.add('active');
            currentActiveMode = 'memorize';
        } else { 
            listenModeUI.style.display = 'none';
            memorizeModeUI.style.display = 'none';
            sentenceContainerShared.style.display = 'none';
            currentActiveMode = null;
        }
        console.log(`[GLOBAL] Mode switched. New active: ${currentActiveMode}`);
    }

    btnSelectListen.addEventListener('click', () => switchToMode('listen'));
    btnSelectMemorize.addEventListener('click', () => switchToMode('memorize'));

    switchToMode(null); 
    console.log("[GLOBAL] Page loaded. Select a mode to begin.");

    // Simplified functions for brevity in the explanation
    // Full implementations are above
    listen_resetHighlights = function() { listen_words.forEach(w => {w.classList.remove("highlight-active-word","processed-word");}); listen_audioWasEnded = false; };
    listen_toggleAudio = function() { if(listen_audioWasEnded){listen_resetHighlights();listen_audioPlayer.currentTime=0;} if(listen_audioPlayer.paused||listen_audioPlayer.ended){if(listen_audioPlayer.ended){listen_audioPlayer.currentTime=0;listen_resetHighlights();}listen_audioPlayer.play();listen_isPaused=false;listen_playPauseButton.textContent="â¸ï¸";}else{listen_audioPlayer.pause();listen_isPaused=true;listen_playPauseButton.textContent="â–¶ï¸";}};
    listen_highlightWords = function() { if(listen_isPaused||listen_audioWasEnded)return;const c=listen_audioPlayer.currentTime;listen_words.forEach((w,i)=>{let t=parseFloat(w.dataset.time),e,n=Infinity;for(let o=i+1;o<listen_words.length;o++)if(listen_words[o].hasAttribute('data-time')){n=parseFloat(listen_words[o].dataset.time);break}n!==Infinity?e=n:e=t+1.0,listen_audioPlayer.duration&&!isNaN(listen_audioPlayer.duration)&&(e=listen_audioPlayer.duration);c>=t&&c<e?(w.classList.add("highlight-active-word"),w.classList.remove("processed-word")):c>=e&&t<c?(w.classList.add("processed-word"),w.classList.remove("highlight-active-word")):(w.classList.remove("highlight-active-word"),w.classList.remove("processed-word"))});!listen_audioPlayer.ended&&listen_audioPlayer.currentTime>=listen_audioPlayer.duration-0.1&&listen_audioPlayer.duration>0&&(listen_playPauseButton.textContent="ğŸ”„",listen_audioWasEnded=!0,listen_words.forEach(w=>{w.hasAttribute('data-time')&&parseFloat(w.dataset.time)<=listen_audioPlayer.currentTime&&(w.classList.add('processed-word'),w.classList.remove('highlight-active-word'))}))};
    deactivateListenMode = function() { console.log("[LISTEN] Deactivating Listen Mode."); if(listen_audioPlayer&&!listen_audioPlayer.paused)listen_audioPlayer.pause();listen_playPauseButton.textContent="â–¶ï¸";listenModeUI.style.display='none';listen_playPauseButton.onclick=null;listen_audioPlayer.ontimeupdate=null;listen_audioPlayer.onended=null;listen_audioPlayer.onplay=null;listen_audioPlayer.onseeked=null;listen_words.forEach(w=>w.onclick=null);console.log("[LISTEN] Listen mode deactivated.");};
    memorize_normalizeArabic = function(t) { return t?(t=t.replace(/[Ø¥Ø£Ø¢Ù±]/g,"Ø§").replace(/Ù‰/g,"ÙŠ").replace(/Ø¤/g,"Ùˆ").replace(/Ø¦/g,"ÙŠ").replace(/Ø©/g,"Ù‡").trim()):"" };
    if(SpeechRecognitionAPI){memorize_recognition.onstart=()=>{console.log("[MEMORIZE] SpeechRecognition.onstart");memorize_isRecognizing=!0;memorize_accumulatedFinalTranscript="";memorize_speechButton.textContent="ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...";memorize_speechButton.classList.add('listening');memorize_speechStatus.textContent="ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†...";if(memorize_restartTimeout)clearTimeout(memorize_restartTimeout);if(memorize_silenceTimeout)clearTimeout(memorize_silenceTimeout);memorize_restartTimeout=null;memorize_silenceTimeout=null;};memorize_recognition.onend=()=>{console.log("[MEMORIZE] SpeechRecognition.onend");memorize_isRecognizing=!1;if(memorize_restartTimeout)clearTimeout(memorize_restartTimeout);if(memorize_silenceTimeout)clearTimeout(memorize_silenceTimeout);memorize_restartTimeout=null;memorize_silenceTimeout=null;memorize_shouldRestart&&memorize_currentWordIndex<memorize_wordSpans.length?(console.log("[MEMORIZE] Auto-restarting recognition..."),memorize_restartTimeout=setTimeout(()=>{!memorize_isRecognizing&&memorize_shouldRestart&&memorize_currentWordIndex<memorize_wordSpans.length&&memorize_recognition.start()},100)):memorize_updateUIForStopped()};memorize_updateUIForStopped=function(){console.log("[MEMORIZE] memorize_updateUIForStopped");memorize_speechButton.textContent="ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯Ø«";memorize_speechButton.classList.remove('listening');memorize_currentWordIndex<memorize_wordSpans.length&&memorize_currentWordIndex>0?memorize_speechStatus.textContent="ØªÙˆÙ‚Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹. Ø§Ø¶ØºØ· Ù„Ù…ØªØ§Ø¨Ø¹Ø©.":0===memorize_currentWordIndex?memorize_speechStatus.textContent="Ø§Ø¶ØºØ· \"Ø§Ø¨Ø¯Ø£\" ÙˆØªØ­Ø¯Ø«":memorize_speechStatus.textContent="Ø£Ø­Ø³Ù†Øª! Ù…ÙƒØªÙ…Ù„. Ø§Ø¶ØºØ· \"Ø¥Ø¹Ø§Ø¯Ø©\" Ù„Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯."};memorize_recognition.onerror=e=>{console.error("[MEMORIZE] SpeechRecognition.onerror:",e.error,e.message);let o="Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ: "+e.error;if("aborted"===e.error&&memorize_shouldRestart)return;"no-speech"===e.error?(memorize_shouldRestart&&memorize_currentWordIndex<memorize_wordSpans.length||(o="Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£ÙŠ ÙƒÙ„Ø§Ù…. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...")):["audio-capture","not-allowed","network","service-not-allowed"].includes(e.error)&&(memorize_shouldRestart=!1,"audio-capture"===e.error&&(o="Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†."),"not-allowed"===e.error&&(o="ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†."),"network"===e.error&&(o="Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© ØªÙ…Ù†Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ."),"service-not-allowed"===e.error&&(o="Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§."));memorize_shouldRestart&&"no-speech"!==e.error||(memorize_speechStatus.textContent=o,memorize_isRecognizing=!1,memorize_updateUIForStopped())}}
    memorize_toggleSpeechRecognition=function(){if(!SpeechRecognitionAPI)return void console.warn("[MEMORIZE] toggleSpeechRecognition: API not supported.");console.log(`[MEMORIZE] toggleSpeechRecognition. Current: isRec=${memorize_isRecognizing}, shouldRes=${memorize_shouldRestart}`);if(memorize_isRecognizing||memorize_shouldRestart)console.log("[MEMORIZE] Stopping recognition."),memorize_shouldRestart=!1,memorize_restartTimeout&&clearTimeout(memorize_restartTimeout),memorize_silenceTimeout&&clearTimeout(memorize_silenceTimeout),memorize_restartTimeout=null,memorize_silenceTimeout=null,memorize_isRecognizing?memorize_recognition.stop():memorize_updateUIForStopped();else{if(memorize_currentWordIndex>=memorize_wordSpans.length)console.log("[MEMORIZE] All words done, resetting."),memorize_resetActivity();console.log("[MEMORIZE] Starting recognition."),memorize_shouldRestart=!0;try{memorize_recognition.start()}catch(e){console.error("[MEMORIZE] Error calling recognition.start():",e),memorize_speechStatus.textContent="Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø±Ù: "+e.message,memorize_shouldRestart=!1,memorize_isRecognizing=!1,memorize_updateUIForStopped()}}};
    deactivateMemorizeMode=function(){console.log("[MEMORIZE] Deactivating Memorize Mode.");SpeechRecognitionAPI&&memorize_recognition&&memorize_isRecognizing&&(memorize_shouldRestart=!1,memorize_recognition.stop());memorize_restartTimeout&&clearTimeout(memorize_restartTimeout);memorize_silenceTimeout&&clearTimeout(memorize_silenceTimeout);memorize_restartTimeout=null;memorize_silenceTimeout=null;memorizeModeUI.style.display='none';memorize_speechButton.onclick=null;memorize_resetButton.onclick=null;console.log("[MEMORIZE] Memorize mode deactivated.");};

</script>
</body>
</html>
